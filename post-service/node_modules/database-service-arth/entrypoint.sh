#!/bin/bash

# Start MariaDB (MySQL-compatible)
service mariadb start

# Wait for MySQL/MariaDB to be ready
until mysqladmin ping -h "localhost" --silent; do
  echo "Waiting for MariaDB (MySQL) to start..."
  sleep 2
done

mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED BY '12345';"
mysql -e "CREATE DATABASE IF NOT EXISTS threadhive;"
mysql -e "GRANT ALL PRIVILEGES ON threadhive.* TO 'root'@'%' IDENTIFIED BY '12345';"
mysql -e "FLUSH PRIVILEGES;"

echo "MariaDB (MySQL) is up and running!"

# Create the database if it doesn't exist
mysql -e "CREATE DATABASE IF NOT EXISTS threadhive;"

# Run database migrations
yarn migrate

# Start the NestJS application
yarn start
